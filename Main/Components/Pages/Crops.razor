@page "/crops"
@using static MudBlazor.Icons
@using System.Linq
@inject IDialogService DialogService
@inject ISnackbar Snackbar

<style>
    .crops-header {
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        color: white;
        padding: 2rem;
        border-radius: 8px;
        margin-bottom: 2rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .slot-card {
        transition: all 0.2s ease;
        cursor: pointer;
    }

        .slot-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .slot-card.selected {
            border: 2px solid #11998e !important;
            background-color: #f0fdf4;
        }

    .lettuce-option {
        transition: all 0.2s ease;
    }

        .lettuce-option:hover {
            background-color: #f0fdf4;
        }

    .crop-card {
        transition: all 0.3s ease;
    }

        .crop-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.15);
        }

    .stat-card {
        transition: all 0.2s ease;
    }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(17, 153, 142, 0.2);
        }
</style>

<div class="crops-header">
    <h3 style="margin: 0; font-size: 1.8rem; font-weight: 600;">
        <MudIcon Icon="@Icons.Material.Filled.Grass" Style="vertical-align: middle; margin-right: 0.5rem;" />
        Crops Management
    </h3>
    <p style="margin: 0.5rem 0 0 0; opacity: 0.9;">Manage your lettuce batches and track growth progress</p>
</div>

@* --- PERMANENT STATS ROW --- *@
<MudGrid Justify="Justify.Center" Class="mb-6">
    <MudItem xs="12" sm="10" md="12" lg="10">
        <MudGrid Spacing="4">
            <MudItem xs="12" sm="6" md="4">
                <MudPaper Elevation="0" Outlined="true" Class="pa-4 stat-card" Style="border-radius: 12px; border: 2px solid #e5e7eb;">
                    <MudStack Spacing="1">
                        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                            <MudText Typo="Typo.body2" Style="color: #6b7280; font-weight: 500;">Active Crops</MudText>
                            <MudIcon Icon="@Icons.Material.Filled.Grass" Style="color: #11998e;" Size="Size.Large" />
                        </MudStack>
                        <MudText Typo="Typo.h3" Style="font-weight: 700; color: #1f2937;">@VisibleCrops.Count</MudText>
                    </MudStack>
                </MudPaper>
            </MudItem>
            <MudItem xs="12" sm="6" md="4">
                <MudPaper Elevation="0" Outlined="true" Class="pa-4 stat-card" Style="border-radius: 12px; border: 2px solid #e5e7eb;">
                    <MudStack Spacing="1">
                        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                            <MudText Typo="Typo.body2" Style="color: #6b7280; font-weight: 500;">Crops Harvested</MudText>
                            <MudIcon Icon="@Icons.Material.Filled.TaskAlt" Style="color: #11998e;" Size="Size.Large" />
                        </MudStack>
                        <MudText Typo="Typo.h3" Style="font-weight: 700; color: #1f2937;">@TotalCropsHarvested</MudText>
                    </MudStack>
                </MudPaper>
            </MudItem>
            <MudItem xs="12" sm="6" md="4">
                <MudPaper Elevation="0" Outlined="true" Class="pa-4 stat-card" Style="border-radius: 12px; border: 2px solid #e5e7eb;">
                    <MudStack Spacing="1">
                        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                            <MudText Typo="Typo.body2" Style="color: #6b7280; font-weight: 500;">Batches Harvested</MudText>
                            <MudIcon Icon="@Icons.Material.Filled.Inventory" Style="color: #11998e;" Size="Size.Large" />
                        </MudStack>
                        <MudText Typo="Typo.h3" Style="font-weight: 700; color: #1f2937;">@TotalBatchesHarvested</MudText>
                    </MudStack>
                </MudPaper>
            </MudItem>
        </MudGrid>
    </MudItem>
</MudGrid>

@* --- Conditional Form --- *@
@if (VisibleCrops.Count == 0)
{
    <MudGrid Justify="Justify.Center" Class="mt-6">
        <MudItem xs="12" lg="10" xl="8">
            <MudPaper Elevation="2" Class="pa-6" Style="border-radius: 16px; background: linear-gradient(135deg, #ffffff 0%, #f9fafb 100%);">
                <MudStack Spacing="4">
                    @* Header Section *@
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                        <MudIcon Icon="@Icons.Material.Filled.Spa" Style="color: #11998e;" Size="Size.Large" />
                        <MudStack Spacing="0">
                            <MudText Typo="Typo.h5" Style="font-weight: 600; color: #1f2937;">Start Your First Batch</MudText>
                            <MudText Typo="Typo.body2" Style="color: #6b7280;">Select lettuce types for each slot. You don't need to use all four slots.</MudText>
                        </MudStack>
                    </MudStack>

                    <MudDivider />

                    @* Slot Selection *@
                    <MudGrid Spacing="3">
                        @foreach (var slot in _newBatchSlots)
                        {
                            var currentSlot = slot;
                            var slotIndex = _newBatchSlots.IndexOf(slot);
                            var slotClass = $"pa-4 slot-card {(string.IsNullOrEmpty(currentSlot.Type) ? "" : "selected")}";
                            <MudItem xs="12" sm="6">
                                <MudPaper Elevation="0"
                                          Outlined="true"
                                          Class="@slotClass"
                                          Style="border-radius: 12px; border: 2px solid #e5e7eb;">
                                    <MudStack Spacing="2">
                                        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                            <MudText Typo="Typo.h6" Style="font-weight: 600; color: #1f2937;">Slot @(slotIndex + 1)</MudText>
                                            @if (!string.IsNullOrEmpty(currentSlot.Type))
                                            {
                                                <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Style="color: #11998e;" />
                                            }
                                        </MudStack>

                                        <select @bind="currentSlot.Type" class="form-select" style="border-radius: 8px; padding: 10px;">
                                            <option value="">-- Select Type --</option>
                                            @foreach (var lettuceType in _lettuceTypes)
                                            {
                                                <option value="@lettuceType">@lettuceType (@_lettuceGrowDays[lettuceType] days)</option>
                                            }
                                        </select>
                                    </MudStack>
                                </MudPaper>
                            </MudItem>
                        }
                    </MudGrid>

                    @* Action Buttons *@
                    <MudStack Row="true" Justify="Justify.FlexEnd" Spacing="2" Class="mt-2">
                        <MudButton Variant="Variant.Text"
                                   Color="Color.Default"
                                   OnClick="ClearBatchForm"
                                   Style="text-transform: none;">
                            Clear All
                        </MudButton>
                        <MudButton Variant="Variant.Filled"
                                   Color="Color.Success"
                                   StartIcon="@Icons.Material.Filled.PlayArrow"
                                   OnClick="StartBatch"
                                   Disabled="@(!_newBatchSlots.Any(s => !string.IsNullOrEmpty(s.Type)))"
                                   Style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; text-transform: none; padding: 8px 24px; border-radius: 8px;">
                            Start Batch
                        </MudButton>
                    </MudStack>
                </MudStack>
            </MudPaper>
        </MudItem>
    </MudGrid>
}

@* --- Conditional Crop Display --- *@
@if (VisibleCrops.Count > 0)
{
    <MudGrid Spacing="4" Class="mt-4">
        @foreach (var crop in VisibleCrops)
        {
            <MudItem xs="12" sm="6" md="4" lg="3">
                <MudCard Class="crop-card" Style="border-radius: 12px; overflow: hidden; height: 100%;">
                    <MudCardMedia Image="@GetImagePath(crop.Type)" Height="200" Style="object-fit: cover;" />
                    <MudCardContent>
                        <MudStack Spacing="2">
                            <MudText Typo="Typo.h6" Style="font-weight: 600; color: #1f2937;">@crop.Name</MudText>

                            <MudStack Spacing="1">
                                <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center">
                                    <MudIcon Icon="@Icons.Material.Filled.CalendarToday" Size="Size.Small" Style="color: #6b7280;" />
                                    <MudText Typo="Typo.body2" Style="color: #6b7280;">
                                        <b>@crop.DaysGrowing</b> days growing
                                    </MudText>
                                </MudStack>

                                <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center">
                                    <MudIcon Icon="@Icons.Material.Filled.DateRange" Size="Size.Small" Style="color: #6b7280;" />
                                    <MudText Typo="Typo.body2" Style="color: #6b7280;">
                                        Planted: @crop.StartDate.ToShortDateString()
                                    </MudText>
                                </MudStack>

                                <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center">
                                    <MudIcon Icon="@Icons.Material.Filled.Agriculture" Size="Size.Small" Style="color: #11998e;" />
                                    <MudText Typo="Typo.body2" Style="color: #11998e; font-weight: 500;">
                                        Harvest: @GetHarvestDate(crop.Type, crop.StartDate)
                                    </MudText>
                                </MudStack>
                            </MudStack>

                            @* Progress Bar *@
                            <MudProgressLinear Color="Color.Success"
                                               Value="@GetGrowthProgress(crop.Type, crop.DaysGrowing)"
                                               Size="Size.Small"
                                               Style="border-radius: 4px; height: 8px;" />
                            <MudText Typo="Typo.caption" Style="color: #6b7280;" Align="Align.Center">
                                @GetGrowthProgress(crop.Type, crop.DaysGrowing).ToString("F0")% Complete
                            </MudText>
                        </MudStack>
                    </MudCardContent>

                    <MudCardActions Class="pa-4">
                        <MudButton Variant="Variant.Filled"
                                   Color="Color.Success"
                                   FullWidth="true"
                                   StartIcon="@Icons.Material.Filled.Agriculture"
                                   OnClick="() => ShowHarvestConfirmation(crop)"
                                   Style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; text-transform: none; border-radius: 8px;">
                            Harvest Now
                        </MudButton>
                    </MudCardActions>
                </MudCard>
            </MudItem>
        }
    </MudGrid>
}


@code {
    private List<Crop> ActiveCrops = new();
    private List<Crop> VisibleCrops => ActiveCrops.Where(c => c.EndTime == null).ToList();
    private int TotalCropsHarvested => ActiveCrops.Count(c => c.EndTime != null);
    private int TotalBatchesHarvested = 0;

    private List<NewBatchSlot> _newBatchSlots = new();
    private List<string> _lettuceTypes = new() { "Romaine Lettuce", "Butterhead Lettuce", "Iceberg Lettuce", "Looseleaf Lettuce" };

    private Dictionary<string, int> _lettuceGrowDays = new()
    {
        { "Romaine Lettuce", 50 },
        { "Butterhead Lettuce", 45 },
        { "Iceberg Lettuce", 55 },
        { "Looseleaf Lettuce", 40 }
    };

    private class NewBatchSlot
    {
        public string? Type { get; set; } = null;
    }

    private class Crop
    {
        public string Name { get; set; } = "";
        public string Type { get; set; } = "";
        public DateTime StartDate { get; set; }
        public int DaysGrowing => (DateTime.Now - StartDate).Days;
        public DateTime? EndTime { get; set; } = null;
    }

    private double GetGrowthProgress(string type, int daysGrowing)
    {
        if (_lettuceGrowDays.TryGetValue(type, out int totalDays))
        {
            return Math.Min((daysGrowing / (double)totalDays) * 100, 100);
        }
        return 0;
    }

    private string GetHarvestDate(string type, DateTime startDate)
    {
        if (_lettuceGrowDays.TryGetValue(type, out int days))
        {
            return startDate.AddDays(days).ToShortDateString();
        }
        return "N/A";
    }

    private string GetImagePath(string lettuceType)
    {
        switch (lettuceType)
        {
            case "Romaine Lettuce": return "images/romaine.jpg";
            case "Butterhead Lettuce": return "images/butterhead.jpg";
            case "Iceberg Lettuce": return "images/iceberg.jpg";
            case "Looseleaf Lettuce": return "images/looseleaf.jpg";
            default: return "dotnet_bot.svg";
        }
    }

    protected override void OnInitialized()
    {
        _newBatchSlots = new List<NewBatchSlot>
        {
            new NewBatchSlot(),
            new NewBatchSlot(),
            new NewBatchSlot(),
            new NewBatchSlot()
        };
    }

    private async Task ClearBatchForm()
    {
        _newBatchSlots = new List<NewBatchSlot>
        {
            new NewBatchSlot(), new NewBatchSlot(), new NewBatchSlot(), new NewBatchSlot()
        };
        await InvokeAsync(StateHasChanged);
    }

    private async Task HarvestCrop(Crop cropToHarvest)
    {
        var crop = ActiveCrops.FirstOrDefault(c => c.Name == cropToHarvest.Name && c.StartDate == cropToHarvest.StartDate);
        if (crop != null)
        {
            crop.EndTime = DateTime.Now;

            if (VisibleCrops.Count == 0)
            {
                TotalBatchesHarvested++;
            }
        }
        await InvokeAsync(StateHasChanged);
    }

    private async Task ShowHarvestConfirmation(Crop crop)
    {
        var result = await DialogService.ShowMessageBox(
            "Confirm Harvest",
            $"Are you sure you want to harvest {crop.Name}? This action cannot be undone.",
            yesText: "Harvest",
            cancelText: "Cancel"
        );

        if (result == true)
        {
            await HarvestCrop(crop);
            Snackbar.Add($"{crop.Name} has been harvested.", Severity.Success);
        }
    }

    private async Task StartBatch()
    {
        var newCrops = _newBatchSlots
            .Where(slot => !string.IsNullOrEmpty(slot.Type))
            .ToList();

        if (newCrops.Any())
        {
            var typeCounts = new Dictionary<string, char>();
            foreach (var slot in newCrops)
            {
                if (!typeCounts.TryGetValue(slot.Type!, out var letter)) { letter = 'A'; }

                ActiveCrops.Add(new Crop
                {
                    Type = slot.Type!,
                    Name = $"{slot.Type} {letter}",
                    StartDate = DateTime.Now,
                    EndTime = null
                });
                typeCounts[slot.Type!] = (char)(letter + 1);
            }
        }
        await ClearBatchForm();
    }
}