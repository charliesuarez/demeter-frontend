@page "/"
@using Main.Bluetooth
@using static MudBlazor.Icons
@inject IBluetoothService Bluetooth
@implements IDisposable

<style>
    .overview-header {
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        color: white;
        padding: 2rem;
        border-radius: 8px;
        margin-bottom: 2rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .stat-card {
        transition: all 0.3s ease;
        border: 2px solid #e5e7eb !important;
    }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 16px rgba(17, 153, 142, 0.2);
            border-color: #11998e !important;
        }

    .metric-card {
        transition: all 0.3s ease;
        border: 2px solid #A5D6A7 !important;
        background: linear-gradient(135deg, #E8F5E9 0%, #F1F8E9 100%) !important;
    }

        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(17, 153, 142, 0.15);
        }

    .alert-card {
        transition: all 0.3s ease;
    }

        .alert-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

    .status-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 0.5rem;
    }

    .status-connected {
        background: #10b981;
        animation: pulse 2s infinite;
    }

    .status-disconnected {
        background: #ef4444;
    }

    @@keyframes pulse {
        0%, 100% {
            opacity: 1;
            box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7);
        }

        50% {
            opacity: 0.8;
            box-shadow: 0 0 0 8px rgba(16, 185, 129, 0);
        }
    }

    .live-badge {
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        color: white;
        padding: 0.4rem 1rem;
        border-radius: 20px;
        font-weight: 600;
        font-size: 0.85rem;
        display: flex;
        align-items: center;
        gap: 0.3rem;
    }

    .offline-badge {
        background: #6b7280;
        color: white;
        padding: 0.4rem 1rem;
        border-radius: 20px;
        font-weight: 600;
        font-size: 0.85rem;
    }
    
    @@media (max-width: 600px) {
        .overview-header {
            padding: 1rem;
        }

        .overview-header h3 {
            font-size: 1.3rem;
        }

        .metric-card {
            padding: 8px !important;
        }

        .metric-card .mud-typography-body2 {
            font-size: 0.65rem !important;
        }

        .metric-card .mud-typography-h5 {
            font-size: 1rem !important;
        }

        .metric-card > .mud-paper-outlined {
            padding: 8px !important;
        }
    }

</style>

<div class="overview-header">
    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
        <div>
            <h3 style="margin: 0; font-size: 1.8rem; font-weight: 600;">
                <MudIcon Icon="@Icons.Material.Filled.Dashboard" Style="vertical-align: middle; margin-right: 0.5rem;" />
                System Overview
            </h3>
            <p style="margin: 0.5rem 0 0 0; opacity: 0.9;">Real-time monitoring of your hydroponic system</p>
        </div>
        @if (!_isConnected)
        {
            <MudButton Variant="Variant.Filled"
                       Color="Color.Default"
                       StartIcon="@Icons.Material.Filled.Bluetooth"
                       OnClick="ShowConnectionDialog"
                       Style="background: white; color: #11998e;">
                Connect Device
            </MudButton>
        }
    </MudStack>
</div>

@* --- CROP STATS --- *@
<MudGrid Spacing="4" Class="mb-6">
    <MudItem xs="6" sm="6" md="3">
        <MudPaper Elevation="0" Outlined="true" Class="pa-4 stat-card" Style="border-radius: 12px;">
            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                <MudStack Spacing="1">
                    <MudText Typo="Typo.body2" Style="color: #6b7280; font-weight: 500;">Total Crops</MudText>
                    <MudText Typo="Typo.h4" Style="font-weight: 700; color: #1f2937;">4</MudText>
                </MudStack>
                <MudIcon Icon="@Icons.Material.Filled.Grass" Style="color: #11998e;" Size="Size.Large" />
            </MudStack>
        </MudPaper>
    </MudItem>

    <MudItem xs="6" sm="6" md="3">
        <MudPaper Elevation="0" Outlined="true" Class="pa-4 stat-card" Style="border-radius: 12px;">
            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                <MudStack Spacing="1">
                    <MudText Typo="Typo.body2" Style="color: #6b7280; font-weight: 500;">Healthy Crops</MudText>
                    <MudText Typo="Typo.h4" Style="font-weight: 700; color: #1f2937;">4</MudText>
                </MudStack>
                <MudIcon Icon="@Icons.Material.Filled.Favorite" Style="color: #11998e;" Size="Size.Large" />
            </MudStack>
        </MudPaper>
    </MudItem>

    <MudItem xs="6" sm="6" md="3">
        <MudPaper Elevation="0" Outlined="true" Class="pa-4 stat-card" Style="border-radius: 12px;">
            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                <MudStack Spacing="1">
                    <MudText Typo="Typo.body2" Style="color: #6b7280; font-weight: 500;">Average Health</MudText>
                    <MudText Typo="Typo.h4" Style="font-weight: 700; color: #1f2937;">95%</MudText>
                </MudStack>
                <MudIcon Icon="@Icons.Material.Filled.TrendingUp" Style="color: #11998e;" Size="Size.Large" />
            </MudStack>
        </MudPaper>
    </MudItem>

    <MudItem xs="6" sm="6" md="3">
        <MudPaper Elevation="0" Outlined="true" Class="pa-4 stat-card" Style="border-radius: 12px;">
            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                <MudStack Spacing="1">
                    <MudText Typo="Typo.body2" Style="color: #6b7280; font-weight: 500;">Active Alerts</MudText>
                    <MudText Typo="Typo.h4" Style="font-weight: 700; color: #1f2937;">@_alerts.Count</MudText>
                </MudStack>
                <MudIcon Icon="@Icons.Material.Filled.Report" Style="color: #11998e;" Size="Size.Large" />
            </MudStack>
        </MudPaper>
    </MudItem>
</MudGrid>

@* --- MAIN + SIDEBAR LAYOUT --- *@
<MudGrid Spacing="4">
    @* --- MAIN CONTENT (Metrics) --- *@
    <MudItem xs="12" md="8">
        <MudPaper Elevation="2" Class="pa-3 pa-sm-5" Style="border-radius: 12px;">
            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-4">
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                    <MudIcon Icon="@Icons.Material.Filled.Sensors" Style="color: #11998e;" Size="Size.Medium" />
                    <MudText Typo="Typo.h5" Style="font-weight: 600; color: #1f2937;">Environmental Metrics</MudText>
                </MudStack>
                @if (_isConnected)
                {
                    <div class="live-badge">
                        <MudIcon Icon="@Icons.Material.Filled.Refresh" Size="Size.Small" />
                        <span>Live</span>
                    </div>
                }
                else
                {
                    <span class="offline-badge">Offline</span>
                }
            </MudStack>

            <MudGrid Spacing="3">
                @* Row 1 *@
                <MudItem xs="6" sm="6">
                    <MudPaper Elevation="0" Outlined="true" Class="pa-3 metric-card" Style="border-radius: 12px;">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="3">
                            <div style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); padding: 8px; border-radius: 12px;">
                                <MudIcon Icon="@Icons.Material.Filled.InvertColors" Style="color: white;" Size="Size.Large" />
                            </div>
                            <MudStack Spacing="0" Style="flex: 1;">
                                <MudText Typo="Typo.body2" Style="color: #6b7280; font-weight: 500;">Solution pH</MudText>
                                <MudText Typo="Typo.h5" Style="font-weight: 700; color: #1f2937;">@FormatValue(_sensorData?.Ph, "F1")</MudText>
                            </MudStack>
                        </MudStack>
                    </MudPaper>
                </MudItem>

                <MudItem xs="6" sm="6">
                    <MudPaper Elevation="0" Outlined="true" Class="pa-3 metric-card" Style="border-radius: 12px;">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="3">
                            <div style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); padding: 8px; border-radius: 12px;">
                                <MudIcon Icon="@Icons.Material.Filled.Thermostat" Style="color: white;" Size="Size.Large" />
                            </div>
                            <MudStack Spacing="0" Style="flex: 1;">
                                <MudText Typo="Typo.body2" Style="color: #6b7280; font-weight: 500;">Water Temp</MudText>
                                <MudText Typo="Typo.h5" Style="font-weight: 700; color: #1f2937;">@FormatValue(_sensorData?.WaterTemp, "F1", "°C")</MudText>
                            </MudStack>
                        </MudStack>
                    </MudPaper>
                </MudItem>

                @* Row 2 *@
                <MudItem xs="6" sm="6">
                    <MudPaper Elevation="0" Outlined="true" Class="pa-3 metric-card" Style="border-radius: 12px;">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="3">
                            <div style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); padding: 8px; border-radius: 12px;">
                                <MudIcon Icon="@Icons.Material.Filled.Water" Style="color: white;" Size="Size.Large" />
                            </div>
                            <MudStack Spacing="0" Style="flex: 1;">
                                <MudText Typo="Typo.body2" Style="color: #6b7280; font-weight: 500;">Water Level</MudText>
                                <MudText Typo="Typo.h5" Style="font-weight: 700; color: #1f2937;">@FormatValue(_sensorData?.WaterLevel, "F1", " cm")</MudText>
                            </MudStack>
                        </MudStack>
                    </MudPaper>
                </MudItem>

                <MudItem xs="6" sm="6">
                    <MudPaper Elevation="0" Outlined="true" Class="pa-3 metric-card" Style="border-radius: 12px;">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="3">
                            <div style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); padding: 8px; border-radius: 12px;">
                                <MudIcon Icon="@Icons.Material.Filled.Air" Style="color: white;" Size="Size.Large" />
                            </div>
                            <MudStack Spacing="0" Style="flex: 1;">
                                <MudText Typo="Typo.body2" Style="color: #6b7280; font-weight: 500;">Dissolved O₂</MudText>
                                <MudText Typo="Typo.h5" Style="font-weight: 700; color: #1f2937;">@FormatValue(_sensorData?.DissolvedOxygen, "F1", " mg/L")</MudText>
                            </MudStack>
                        </MudStack>
                    </MudPaper>
                </MudItem>

                @* Row 3 *@
                <MudItem xs="6" sm="6">
                    <MudPaper Elevation="0" Outlined="true" Class="pa-3 metric-card" Style="border-radius: 12px;">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="3">
                            <div style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); padding: 8px; border-radius: 12px;">
                                <MudIcon Icon="@Icons.Material.Filled.WbSunny" Style="color: white;" Size="Size.Large" />
                            </div>
                            <MudStack Spacing="0" Style="flex: 1;">
                                <MudText Typo="Typo.body2" Style="color: #6b7280; font-weight: 500;">Light</MudText>
                                <MudText Typo="Typo.h5" Style="font-weight: 700; color: #1f2937;">@FormatValue(_sensorData?.Light, "F0", " lux")</MudText>
                            </MudStack>
                        </MudStack>
                    </MudPaper>
                </MudItem>

                <MudItem xs="6" sm="6">
                    <MudPaper Elevation="0" Outlined="true" Class="pa-3 metric-card" Style="border-radius: 12px;">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="3">
                            <div style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); padding: 8px; border-radius: 12px;">
                                <MudIcon Icon="@Icons.Material.Filled.Bolt" Style="color: white;" Size="Size.Large" />
                            </div>
                            <MudStack Spacing="0" Style="flex: 1;">
                                <MudText Typo="Typo.body2" Style="color: #6b7280; font-weight: 500;">TDS</MudText>
                                <MudText Typo="Typo.h5" Style="font-weight: 700; color: #1f2937;">@FormatValue(_sensorData?.Tds, "F0", " ppm")</MudText>
                            </MudStack>
                        </MudStack>
                    </MudPaper>
                </MudItem>
            </MudGrid>
        </MudPaper>
    </MudItem>

    @* --- SIDEBAR (Status + Controls) --- *@
    <MudItem xs="12" md="4">
        @* Connection Status Card *@
        <MudPaper Elevation="2" Class="pa-4 mb-4 alert-card" Style="border-radius: 12px;">
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="mb-3">
                <MudIcon Icon="@Icons.Material.Filled.Bluetooth" Style="color: #11998e;" Size="Size.Medium" />
                <MudText Typo="Typo.h6" Style="font-weight: 600; color: #1f2937;">Connection</MudText>
            </MudStack>
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2"
                      Style="@($"padding: 1rem; background: {(_isConnected ? "linear-gradient(135deg, #E8F5E9 0%, #F1F8E9 100%)" : "#fef2f2")}; border-radius: 8px;")">
                <div class="status-indicator @(_isConnected ? "status-connected" : "status-disconnected")"></div>
                @if (_isConnected)
                {
                    <MudStack Spacing="0">
                        <MudText Style="color: #10b981; font-weight: 600;">@Bluetooth.ConnectedDeviceName</MudText>
                        <MudText Typo="Typo.caption" Style="color: #6b7280;">Connected</MudText>
                    </MudStack>
                }
                else
                {
                    <MudText Style="color: #ef4444; font-weight: 600;">Not Connected</MudText>
                }
            </MudStack>
            @if (_isConnected)
            {
                <MudButton Variant="Variant.Text"
                           Color="Color.Error"
                           FullWidth="true"
                           Class="mt-3"
                           OnClick="DisconnectAsync">
                    Disconnect
                </MudButton>
            }
        </MudPaper>

        @* Pump Controls Card *@
        <MudPaper Elevation="2" Class="pa-4 mb-4 alert-card" Style="border-radius: 12px;">
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="mb-3">
                <MudIcon Icon="@Icons.Material.Filled.Settings" Style="color: #11998e;" Size="Size.Medium" />
                <MudText Typo="Typo.h6" Style="font-weight: 600; color: #1f2937;">Pump Controls</MudText>
            </MudStack>
            <MudStack Spacing="2">
                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                    <MudText>Water Pump</MudText>
                    <MudSwitch T="bool" Value="_waterPumpOn" ValueChanged="OnWaterPumpToggle"
                               Color="Color.Success" Disabled="@(!_isConnected)" />
                </MudStack>
                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                    <MudText>Air Pump</MudText>
                    <MudSwitch T="bool" Value="_airPumpOn" ValueChanged="OnAirPumpToggle"
                               Color="Color.Success" Disabled="@(!_isConnected)" />
                </MudStack>
                <MudDivider Class="my-2" />
                <MudText Typo="Typo.body2" Style="color: #6b7280;">Nutrient Dosing</MudText>
                <MudStack Row="true" Spacing="2">
                    <MudTextField T="int" @bind-Value="_doseDuration" Label="Duration (ms)"
                                  Variant="Variant.Outlined" Style="flex: 1;" />
                    <MudButton Variant="Variant.Filled" Color="Color.Primary"
                               OnClick="DoseNutrientsAsync" Disabled="@(!_isConnected)"
                               Style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);">
                        Dose
                    </MudButton>
                </MudStack>
            </MudStack>
        </MudPaper>

        @* Alerts Card *@
        <MudPaper Elevation="2" Class="pa-4 alert-card" Style="border-radius: 12px;">
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="mb-3">
                <MudIcon Icon="@Icons.Material.Filled.Notifications" Style="color: #11998e;" Size="Size.Medium" />
                <MudText Typo="Typo.h6" Style="font-weight: 600; color: #1f2937;">Alerts</MudText>
            </MudStack>
            <MudStack Spacing="2">
                @if (_alerts.Count == 0)
                {
                    <MudText Typo="Typo.body2" Style="color: #6b7280;">No active alerts</MudText>
                }
                @foreach (var alert in _alerts)
                {
                    <MudAlert Severity="@alert.Severity"
                              Variant="Variant.Filled"
                              Style="border-radius: 8px;"
                              CloseIconClicked="() => _alerts.Remove(alert)">
                        @alert.Message
                    </MudAlert>
                }
            </MudStack>
        </MudPaper>
    </MudItem>
</MudGrid>

@* --- CONNECTION DIALOG --- *@
<MudDialog @bind-Visible="_showConnectionDialog" Options="_dialogOptions">
    <TitleContent>
        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
            <MudIcon Icon="@Icons.Material.Filled.BluetoothSearching" />
            <MudText Typo="Typo.h6">Connect to Demeter Controller</MudText>
        </MudStack>
    </TitleContent>
    <DialogContent>
        @if (_isScanning)
        {
            <MudStack AlignItems="AlignItems.Center" Spacing="3" Class="pa-4">
                <MudProgressCircular Indeterminate="true" Color="Color.Primary" />
                <MudText>Scanning for devices...</MudText>
            </MudStack>
        }
        else if (_discoveredDevices.Count == 0)
        {
            <MudText Class="pa-4" Align="Align.Center" Style="color: #6b7280;">
                No devices found. Make sure your ESP32 is powered on.
            </MudText>
        }
        else
        {
            <MudList T="BleDevice" Dense="true">
                @foreach (var device in _discoveredDevices)
                {
                    <MudListItem OnClick="() => ConnectToDeviceAsync(device)">
                        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Style="width: 100%;">
                            <MudStack Spacing="0">
                                <MudText Typo="Typo.body1" Style="font-weight: 600;">@device.Name</MudText>
                                <MudText Typo="Typo.caption" Style="color: #6b7280;">Signal: @GetSignalStrength(device.Rssi)</MudText>
                            </MudStack>
                            <MudIcon Icon="@Icons.Material.Filled.ChevronRight" />
                        </MudStack>
                    </MudListItem>
                }
            </MudList>
        }
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="() => _showConnectionDialog = false">Cancel</MudButton>
        <MudButton Color="Color.Primary" OnClick="StartScanAsync" Disabled="_isScanning">
            @(_isScanning ? "Scanning..." : "Scan")
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    private bool _isConnected;
    private bool _isScanning;
    private bool _showConnectionDialog;
    private SensorData? _sensorData;
    private List<BleDevice> _discoveredDevices = new();
    private List<AlertItem> _alerts = new();
    private string _macAddress;

    private bool _waterPumpOn;
    private bool _airPumpOn;
    private int _doseDuration = 1000;

    private DialogOptions _dialogOptions = new() { MaxWidth = MaxWidth.Small, FullWidth = true };

    protected override async Task OnInitializedAsync()
    {
        // Subscribe to Bluetooth events
        Bluetooth.SensorDataReceived += OnSensorDataReceived;
        Bluetooth.ConnectionChanged += OnConnectionChanged;
        Bluetooth.DeviceDiscovered += OnDeviceDiscovered;
        Bluetooth.ErrorOccurred += OnError;

        // Initialize Bluetooth
        await Bluetooth.InitializeAsync();
    }

    private void OnSensorDataReceived(SensorData data)
    {
        _sensorData = data;
        InvokeAsync(StateHasChanged);
    }

    private void OnConnectionChanged(bool connected)
    {
        _isConnected = connected;
        _showConnectionDialog = false;

        if (!connected)
        {
            _sensorData = null;
            _waterPumpOn = false;
            _airPumpOn = false;
        }

        InvokeAsync(StateHasChanged);
    }

    private void OnDeviceDiscovered(BleDevice device)
    {
        if (!_discoveredDevices.Any(d => d.Id == device.Id))
        {
            _discoveredDevices.Add(device);
            InvokeAsync(StateHasChanged);
        }
    }

    private void OnError(string message)
    {
        _alerts.Add(new AlertItem(Severity.Error, message));
        InvokeAsync(StateHasChanged);
    }

    private void ShowConnectionDialog()
    {
        _discoveredDevices.Clear();
        _showConnectionDialog = true;
    }

    private async Task StartScanAsync()
    {
        _isScanning = true;
        _discoveredDevices.Clear();
        StateHasChanged();

        await Bluetooth.StartScanAsync(timeoutSeconds: 10);

        _isScanning = false;
        StateHasChanged();
    }

    private async Task ConnectToDeviceAsync(BleDevice device)
    {
        try
        {
            await Bluetooth.StopScanAsync();
            await Bluetooth.ConnectAsync(device.Id);
        }
        catch (Exception ex)
        {
            _alerts.Add(new AlertItem(Severity.Error, $"Connection failed: {ex.Message}"));
        }
    }

    private async Task DisconnectAsync()
    {
        await Bluetooth.DisconnectAsync();
    }

    private async Task OnWaterPumpToggle(bool value)
    {
        if (await Bluetooth.SetWaterPumpAsync(value))
            _waterPumpOn = value;
    }

    private async Task OnAirPumpToggle(bool value)
    {
        if (await Bluetooth.SetAirPumpAsync(value))
            _airPumpOn = value;
    }

    private async Task DoseNutrientsAsync()
    {
        if (await Bluetooth.DoseNutrientsAsync(_doseDuration))
            _alerts.Add(new AlertItem(Severity.Info, $"Nutrient dosing started ({_doseDuration}ms)"));
    }

    private string FormatValue(double? value, string format, string suffix = "")
    {
        return value.HasValue ? $"{value.Value.ToString(format)}{suffix}" : "--";
    }

    private string GetSignalStrength(int rssi) => rssi switch
    {
        > -50 => "Excellent",
        > -60 => "Good",
        > -70 => "Fair",
        _ => "Weak"
    };

    public void Dispose()
    {
        Bluetooth.SensorDataReceived -= OnSensorDataReceived;
        Bluetooth.ConnectionChanged -= OnConnectionChanged;
        Bluetooth.DeviceDiscovered -= OnDeviceDiscovered;
        Bluetooth.ErrorOccurred -= OnError;
    }

    private record AlertItem(Severity Severity, string Message);
}
