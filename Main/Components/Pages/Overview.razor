@page "/"
@using Main.Services
@inject ISensorDataService SensorDataService
@inject SensorDataStateContainer StateContainer
@implements IDisposable
@using static MudBlazor.Icons

<style>
    .overview-header {
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        color: white;
        padding: 2rem;
        border-radius: 8px;
        margin-bottom: 2rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .stat-card {
        transition: all 0.3s ease;
        border: 2px solid #e5e7eb !important;
    }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 16px rgba(17, 153, 142, 0.2);
            border-color: #11998e !important;
        }

    .metric-card {
        transition: all 0.3s ease;
        border: 2px solid #A5D6A7 !important;
        background: linear-gradient(135deg, #E8F5E9 0%, #F1F8E9 100%) !important;
    }

        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(17, 153, 142, 0.15);
        }

    .alert-card {
        transition: all 0.3s ease;
    }

        .alert-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

    .status-indicator {
        width: 12px;
        height: 12px;
        background: #10b981;
        border-radius: 50%;
        animation: pulse 2s infinite;
        margin-right: 0.5rem;
    }

    @@keyframes pulse {
        0%, 100% {
            opacity: 1;
            box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7);
        }

        50% {
            opacity: 0.8;
            box-shadow: 0 0 0 8px rgba(16, 185, 129, 0);
        }
    }

    .live-badge {
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        color: white;
        padding: 0.4rem 1rem;
        border-radius: 20px;
        font-weight: 600;
        font-size: 0.85rem;
        display: flex;
        align-items: center;
        gap: 0.3rem;
    }
</style>

<div class="overview-header">
    <h3 style="margin: 0; font-size: 1.8rem; font-weight: 600;">
        <MudIcon Icon="@Icons.Material.Filled.Dashboard" Style="vertical-align: middle; margin-right: 0.5rem;" />
        System Overview
    </h3>
    <p style="margin: 0.5rem 0 0 0; opacity: 0.9;">Real-time monitoring of your hydroponic system</p>
</div>

@* --- CROP STATS --- *@
<MudGrid Spacing="4" Class="mb-6">
    <MudItem xs="12" sm="6" md="3">
        <MudPaper Elevation="0" Outlined="true" Class="pa-4 stat-card" Style="border-radius: 12px;">
            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                <MudStack Spacing="1">
                    <MudText Typo="Typo.body2" Style="color: #6b7280; font-weight: 500;">Total Crops</MudText>
                    <MudText Typo="Typo.h3" Style="font-weight: 700; color: #1f2937;">4</MudText>
                </MudStack>
                <MudIcon Icon="@Icons.Material.Filled.Grass" Style="color: #11998e;" Size="Size.Large" />
            </MudStack>
        </MudPaper>
    </MudItem>

    <MudItem xs="12" sm="6" md="3">
        <MudPaper Elevation="0" Outlined="true" Class="pa-4 stat-card" Style="border-radius: 12px;">
            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                <MudStack Spacing="1">
                    <MudText Typo="Typo.body2" Style="color: #6b7280; font-weight: 500;">Healthy Crops</MudText>
                    <MudText Typo="Typo.h3" Style="font-weight: 700; color: #1f2937;">4</MudText>
                </MudStack>
                <MudIcon Icon="@Icons.Material.Filled.Favorite" Style="color: #11998e;" Size="Size.Large" />
            </MudStack>
        </MudPaper>
    </MudItem>

    <MudItem xs="12" sm="6" md="3">
        <MudPaper Elevation="0" Outlined="true" Class="pa-4 stat-card" Style="border-radius: 12px;">
            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                <MudStack Spacing="1">
                    <MudText Typo="Typo.body2" Style="color: #6b7280; font-weight: 500;">Average Health</MudText>
                    <MudText Typo="Typo.h3" Style="font-weight: 700; color: #1f2937;">95%</MudText>
                </MudStack>
                <MudIcon Icon="@Icons.Material.Filled.TrendingUp" Style="color: #11998e;" Size="Size.Large" />
            </MudStack>
        </MudPaper>
    </MudItem>

    <MudItem xs="12" sm="6" md="3">
        <MudPaper Elevation="0" Outlined="true" Class="pa-4 stat-card" Style="border-radius: 12px;">
            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                <MudStack Spacing="1">
                    <MudText Typo="Typo.body2" Style="color: #6b7280; font-weight: 500;">Active Alerts</MudText>
                    <MudText Typo="Typo.h3" Style="font-weight: 700; color: #1f2937;">2</MudText>
                </MudStack>
                <MudIcon Icon="@Icons.Material.Filled.Report" Style="color: #11998e;" Size="Size.Large" />
            </MudStack>
        </MudPaper>
    </MudItem>
</MudGrid>

@* --- MAIN + SIDEBAR LAYOUT --- *@
<MudGrid Spacing="4">
    @* --- MAIN CONTENT (Metrics) --- *@
    <MudItem xs="12" md="8">
        <MudPaper Elevation="2" Class="pa-5" Style="border-radius: 12px;">
            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-4">
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                    <MudIcon Icon="@Icons.Material.Filled.Sensors" Style="color: #11998e;" Size="Size.Medium" />
                    <MudText Typo="Typo.h5" Style="font-weight: 600; color: #1f2937;">Environmental Metrics</MudText>
                </MudStack>
                <div class="live-badge">
                    <MudIcon Icon="@Icons.Material.Filled.Refresh" Size="Size.Small" />
                    <span>Live</span>
                </div>
            </MudStack>

            <MudGrid Spacing="3">
                @* Row 1 *@
                <MudItem xs="12" sm="6">
                    <MudPaper Elevation="0" Outlined="true" Class="pa-4 metric-card" Style="border-radius: 12px;">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="3">
                            <div style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); padding: 12px; border-radius: 12px;">
                                <MudIcon Icon="@Icons.Material.Filled.InvertColors" Style="color: white;" Size="Size.Large" />
                            </div>
                            <MudStack Spacing="0" Style="flex: 1;">
                                <MudText Typo="Typo.body2" Style="color: #6b7280; font-weight: 500;">Solution pH</MudText>
                                <MudText Typo="Typo.h5" Style="font-weight: 700; color: #1f2937;">7.2</MudText>
                            </MudStack>
                        </MudStack>
                    </MudPaper>
                </MudItem>

                <MudItem xs="12" sm="6">
                    <MudPaper Elevation="0" Outlined="true" Class="pa-4 metric-card" Style="border-radius: 12px;">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="3">
                            <div style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); padding: 12px; border-radius: 12px;">
                                <MudIcon Icon="@Icons.Material.Filled.Thermostat" Style="color: white;" Size="Size.Large" />
                            </div>
                            <MudStack Spacing="0" Style="flex: 1;">
                                <MudText Typo="Typo.body2" Style="color: #6b7280; font-weight: 500;">Water Temperature</MudText>
                                <MudText Typo="Typo.h5" Style="font-weight: 700; color: #1f2937;">22.5°C</MudText>
                            </MudStack>
                        </MudStack>
                    </MudPaper>
                </MudItem>

                @* Row 2 *@
                <MudItem xs="12" sm="6">
                    <MudPaper Elevation="0" Outlined="true" Class="pa-4 metric-card" Style="border-radius: 12px;">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="3">
                            <div style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); padding: 12px; border-radius: 12px;">
                                <MudIcon Icon="@Icons.Material.Filled.Water" Style="color: white;" Size="Size.Large" />
                            </div>
                            <MudStack Spacing="0" Style="flex: 1;">
                                <MudText Typo="Typo.body2" Style="color: #6b7280; font-weight: 500;">Water Level</MudText>
                                <MudText Typo="Typo.h5" Style="font-weight: 700; color: #1f2937;">85%</MudText>
                            </MudStack>
                        </MudStack>
                    </MudPaper>
                </MudItem>

                <MudItem xs="12" sm="6">
                    <MudPaper Elevation="0" Outlined="true" Class="pa-4 metric-card" Style="border-radius: 12px;">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="3">
                            <div style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); padding: 12px; border-radius: 12px;">
                                <MudIcon Icon="@Icons.Material.Filled.Air" Style="color: white;" Size="Size.Large" />
                            </div>
                            <MudStack Spacing="0" Style="flex: 1;">
                                <MudText Typo="Typo.body2" Style="color: #6b7280; font-weight: 500;">Dissolved O₂</MudText>
                                <MudText Typo="Typo.h5" Style="font-weight: 700; color: #1f2937;">8.2 mg/L</MudText>
                            </MudStack>
                        </MudStack>
                    </MudPaper>
                </MudItem>

                @* Row 3 *@
                <MudItem xs="12" sm="6">
                    <MudPaper Elevation="0" Outlined="true" Class="pa-4 metric-card" Style="border-radius: 12px;">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="3">
                            <div style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); padding: 12px; border-radius: 12px;">
                                <MudIcon Icon="@Icons.Material.Filled.WbSunny" Style="color: white;" Size="Size.Large" />
                            </div>
                            <MudStack Spacing="0" Style="flex: 1;">
                                <MudText Typo="Typo.body2" Style="color: #6b7280; font-weight: 500;">Light Control</MudText>
                                <MudText Typo="Typo.h5" Style="font-weight: 700; color: #1f2937;">ON</MudText>
                            </MudStack>
                        </MudStack>
                    </MudPaper>
                </MudItem>

                <MudItem xs="12" sm="6">
                    <MudPaper Elevation="0" Outlined="true" Class="pa-4 metric-card" Style="border-radius: 12px;">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="3">
                            <div style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); padding: 12px; border-radius: 12px;">
                                <MudIcon Icon="@Icons.Material.Filled.Bolt" Style="color: white;" Size="Size.Large" />
                            </div>
                            <MudStack Spacing="0" Style="flex: 1;">
                                <MudText Typo="Typo.body2" Style="color: #6b7280; font-weight: 500;">EC/TDS</MudText>
                                <MudText Typo="Typo.h5" Style="font-weight: 700; color: #1f2937;">1.8 mS/cm</MudText>
                            </MudStack>
                        </MudStack>
                    </MudPaper>
                </MudItem>
            </MudGrid>
        </MudPaper>
    </MudItem>

    @* --- SIDEBAR (Alerts/Status) --- *@
    <MudItem xs="12" md="4">
        @* System Status Card *@
        <MudPaper Elevation="2" Class="pa-4 mb-4 alert-card" Style="border-radius: 12px;">
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="mb-3">
                <MudIcon Icon="@Icons.Material.Filled.Speed" Style="color: #11998e;" Size="Size.Medium" />
                <MudText Typo="Typo.h6" Style="font-weight: 600; color: #1f2937;">System Status</MudText>
            </MudStack>
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Style="padding: 1rem; background: linear-gradient(135deg, #E8F5E9 0%, #F1F8E9 100%); border-radius: 8px;">
                <div class="status-indicator"></div>
                <MudText Style="color: #10b981; font-weight: 600;">All Systems Operational</MudText>
            </MudStack>
        </MudPaper>

        @* Alerts Card *@
        <MudPaper Elevation="2" Class="pa-4 alert-card" Style="border-radius: 12px;">
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="mb-3">
                <MudIcon Icon="@Icons.Material.Filled.Notifications" Style="color: #11998e;" Size="Size.Medium" />
                <MudText Typo="Typo.h6" Style="font-weight: 600; color: #1f2937;">Active Alerts</MudText>
            </MudStack>
            <MudStack Spacing="2">
                <MudAlert Severity="Severity.Info"
                          Variant="Variant.Filled"
                          Icon="@Icons.Material.Filled.Info"
                          Style="border-radius: 8px;">
                    Nutrient dosing started
                </MudAlert>
                <MudAlert Severity="Severity.Warning"
                          Variant="Variant.Filled"
                          Icon="@Icons.Material.Filled.Warning"
                          Style="border-radius: 8px;">
                    pH level is high (7.2)
                </MudAlert>
            </MudStack>
        </MudPaper>
    </MudItem>
</MudGrid>

@code {
    private string? _errorMessage;
    private bool _isRefreshing;

    protected override void OnInitialized()
    {
        StateContainer.onDataUpdated += OnDataUpdated;
        StateContainer.onError += OnError;
        StateContainer.StartPolling();
    }

    private void OnDataUpdated()
    {
        InvokeAsync(StateHasChanged);
    }

    private void OnError(string message)
    {
        _errorMessage = message;
        InvokeAsync(StateHasChanged);
    }

    private async Task RefreshData()
    {
        _isRefreshing = true;
        await StateContainer.RefreshDataAsync();
        _isRefreshing = false;
    }

    private IEnumerable<SensorCardModel> GetSensorCards()
    {
        var readings = StateContainer.LatestData?.Readings;
        if (readings is null) yield break;

        yield return new("pH",          readings.Ph,              "",      "F2", "5.5-6.5",       readings.Ph < 5.5 || readings.Ph > 6.5);
        yield return new("Water Temp",  readings.WaterTemp,       "Â°C",   "F1", "18-24Â°C",      readings.WaterTemp < 18 || readings.WaterTemp > 24);
        yield return new("Air Temp",    readings.AirTemp,         "Â°C",   "F1", "20-28Â°C",      readings.AirTemp < 20 || readings.AirTemp > 28);
        yield return new("Humidity",    readings.Humidity,        "%",     "F0", "50-70%",        readings.Humidity < 50 || readings.Humidity > 70);
        yield return new("TDS",         readings.Tds,             "ppm",   "F0", "800-1200 ppm",  readings.Tds < 800 || readings.Tds > 1200);
        yield return new("EC",          readings.Ec,              "mS/cm", "F2", "1.2-2.0 mS/cm", readings.Ec < 1.2 || readings.Ec > 2.0);
        yield return new("Water Level", readings.WaterLevel,      "cm",    "F1", ">10 cm",        readings.WaterLevel < 10);
        yield return new("Light",       readings.LightIntensity,  "lux",   "N0", ">10,000 lux",   readings.LightIntensity < 10000);
        yield return new("DO",          readings.DissolvedOxygen, "mg/L",  "F1", ">6 mg/L",       readings.DissolvedOxygen < 6);

    }

    public void Dispose()
    {
        StateContainer.onDataUpdated -= OnDataUpdated;
        StateContainer.onError -= OnError;
        StateContainer.StopPolling();
    }

    private record SensorCardModel(
        string Name,
        double Value,
        string Unit,
        string Format,
        string TargetRange,
        bool IsAlert);
}